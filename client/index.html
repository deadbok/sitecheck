<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<!-- Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
			  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
			  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
			<![endif]-->
<link rel="stylesheet" href="css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/custom.css">
<title>Site check</title>
</head>
<body>
	<nav class="navbar navbar-inverse">
		<div class="container-fluid">
			<!-- Brand and toggle get grouped for better mobile display -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed"
					data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"
					aria-expanded="false">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="index.html"> <span
					class="text-uppercase sc-title">Site status</span> <span
					class="sc-version">V0.5.0</span>
				</a>
			</div>

			<!-- Collect the nav links, forms, and other content for toggling -->
			<div class="collapse navbar-collapse"
				id="bs-example-navbar-collapse-1">
				<ul class="nav navbar-nav">
					<li class="active"><a href="index.html">Home</a></li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><span id="n_hosts" class="badge">0</span> <span
						id="con_state" class="pointer sc-connected sc-offline fa fa-unlink"
						aria-hidden="true"> </span></li>
				</ul>
			</div>
			<!-- /.navbar-collapse -->
		</div>
		<!-- /.container-fluid -->
	</nav>
	<div class="container-fluid sc-content">
		<div>
			<div class="btn-group" role="group">
				<!-- Actions -->
				<button type="button" class="btn btn-default">Add</button>
				<button type="button" class="btn btn-default">Delete</button>
			</div>
			<div class="btn-group" role="group">
				<button type="button" class="btn btn-default" id="ping">Ping</button>
				<button type="button" class="btn btn-default" id="diff">Diff</button>
			</div>
			<div class="btn-group" role="group">
				<!-- Trigger the import modal with a button -->
				<button type="button" class="btn btn-default" data-toggle="modal"
					data-target="#importModal">Import host...</button>
			</div>
			<div class="btn-group" role="group">
				<div class="dropdown">
					<button class="btn btn-default dropdown-toggle" type="button"
						id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true"
						aria-expanded="true">
						Hosts per page <span class="caret"></span>
					</button>
					<ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
						<li>10</li>
						<li>25</li>
						<li>50</li>
						<li>100</li>
						<li>All</li>
					</ul>
				</div>
			</div>
			<div class="btn-group" role="group">
				<!--  Search -->
				<form class="form-inline" role="search">
					<div class="form-group">
						<input type="text" class="form-control" placeholder="Search">
					</div>
					<button type="submit"
						class="btn btn-default glyphicon glyphicon-search"></button>
				</form>
			</div>
		</div>

		<!-- Modal -->
		<div id="importModal" class="modal fade" role="dialog">
			<div class="modal-dialog modal-sm">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Select host list file...</h4>
					</div>
					<form enctype="multipart/form-data" method="post"
						id="server_upload_form">
						<div class="modal-body">
							<input name="file" type="file" id="importFile" class="filestyle" />
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" id="importOK"
								data-dismiss="modal">OK</button>
							<button type="button" class="btn btn-default"
								data-dismiss="modal">Cancel</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<br />
		<div class="loader-container" id="loader-container">
			<div id="loader" class="loader"></div>
		</div>
		<form>
			<div class="table-responsive">
				<table id="host_table" style="width: 100%" class="table table-hover">
					<thead>
						<tr>
							<th><input type="checkbox" id="allhost"></th>
							<th class="pointer">
								<span id="name_header"><span id="arrow" class="sort-inactive glyphicon glyphicon-chevron-down"></span>&nbsp;Host</span>
							</th>
							<th class="pointer">
								<span id="ip_value_header"><span id="arrow" class="sort-inactive glyphicon glyphicon-chevron-down"></span>&nbsp;IP</span>
							</th>
							<th class="pointer">
								<span id="state_header"><span id="arrow" class="sort-inactive glyphicon glyphicon-chevron-down"></span>&nbsp;State</span>
							</th>
							<th class="pointer">
								<span id="replyHost_header"><span id="arrow" class="sort-inactive glyphicon glyphicon-chevron-down"></span>&nbsp;Reply from</span>
							</th>
							<th class="pointer">
								<span id="time_value_header"><span id="arrow" class="sort-inactive glyphicon glyphicon-chevron-down"></span>&nbsp;Time</span>
							</th>
							<th id="expand_header" class="pointer"><span id="expand_all"
								class="glyphicon glyphicon-collapse-down"></span></th>
						</tr>
					</thead>
				</table>
			</div>
		</form>
	</div>
	<footer class="navbar-inverse">
		<small><span class="copyright">&copy; Copyright 2016
				Martin Bo Kristensen Gr&oslash;nholdt.</span> <a class="license"
			href="LICENSE">Read license.</a></small>
	</footer>
	<script src="js/jquery.js"></script>
	<script src="js/jsrender.js"></script>
	<script src="js/bootstrap.js"></script>
	<script src="js/bootstrap-filestyle.js"></script>
	<script src="js/protocol.js"></script>
	<script src="js/table.js"></script>
	<script src="js/actions.js"></script>
	<script src="js/date.format.js"></script>

	<!-- jsRender template of a host entry. -->
	<script id="hostBodyTmpl" type="text/x-jsrender">
		<tbody id="{{:id}}_body">
			<tr id="{{:id}}_row" name="{{:name}}">
				<td><input type="checkbox" id="host" name="{{:name}}" value="{{:name}}"></td>
				<td><a id="{{:id}}_link" href="http://{{:name}}/" target="_new">{{:name}}</a></td>
				<td id="{{:id}}_ip">{{:ip}}</td>
				<td id="{{:id}}_state">{{:state}}</td>
				<td id="{{:id}}_replyHost">{{:replyHost}}</td>
				<td id="{{:id}}_time">{{:time}}</td>
				<td><span id="{{:id}}_expand" class="pointer glyphicon glyphicon-collapse-down"></span></td>
			</tr>
			<tr id="{{:id}}_detail" class="collapse">
				<td colspan="0">
					<pre id="{{:id}}_diff">{{:diff_escape}}</pre>
				</td>
			</tr>
		</tbody>
	</script>
	<script type="text/javascript">
		var host_row_tmpl = $.templates("#hostBodyTmpl");
		var hosts = {};
		var sort_value = undefined;
		var sort_keys = [];
		var protocol = new Protocol();
		
		//Change the UI status display when connected.
		protocol.onopen = function()
		{
		    $('#con_state').toggleClass('sc-offline sc-online');
		    $('#con_state').toggleClass('fa-unlink fa-link');
		}
		
		protocol.onhost = function(host)
		{
			addHost(host);
			render(host);
		}
		
		protocol.onlasthost = function()
		{
			// Make sure the spinner is hidden.
			$('#loader').hide();
			$('#loader-container').hide();
		}
		
		//Change the UI status display when disconnected.
		protocol.onclose = function()
		{
		    $('#con_state').toggleClass('sc-offline sc-online');
		    $('#con_state').toggleClass('fa-unlink fa-link');
		}
		
		//Open a connection to the server.
		protocol.open();
		
		//Bind the colapse all funtion.
		$('#expand_all').click(expand_all);
		//Request a ping of some servers.
		$('#ping').click(req_ping);
		//Request a diff of some servers.
		$('#diff').click(req_diff);
		//Connect/disconnect from server.
		$('#con_state').click(toggle_connection);
		//Bind sort select to headers.
		$('span[id$="_header"]').click(select_sort)
		
		//Stolen from: http://stackoverflow.com/questions/24816/escaping-html-strings-with-jquery
		var entityMap = {
				"&": "&amp;",
	   		    "<": "&lt;",
	   		    ">": "&gt;",
	   		    '"': '&quot;',
	   		    "'": '&#39;',
	   		    "/": '&#x2F;'
	   		    };
	
		function escapeHtml(string)
		{
			return String(string).replace(/[&<>"'\/]/g, function (s)
				{
					return entityMap[s];
				});
		}
		
		function addHost(host)
		{
			//Generate CSS safe id.
			host.id = host.name.replace('.', '_').replace('-', '_');
			//Generate IP sort key.
			if ((host.ip == 'Unknown') || (host.ip == undefined))
			{
				host.ip = 'Unknown'
				host.ip_value = 0;
			}
			else
			{
				var ip_split = host.ip.split('.');
				host.ip_value = ip_split[0]*0x1000000 + ip_split[1]*0x10000 + ip_split[2]*0x100 + ip_split[3]*1;
			}
			//Generate time sort key.
			if ((host.time == undefined) || (host.time == 'Never'))
			{
				host.time = 0;	
			}
			//UNIX time to human readable
			host.time_value = host.time
			dt = new Date(host.time * 1000) 
			host.time = new Date(host.time * 1000).format('H:i:s j/n-Y');
			//Escape the diff
			host.diff_escape = escapeHtml(host.diff);
			
			//Check if this is a new host.
			if (hosts[host.name] != undefined)
			{
				//It is not, copy values for UI state from the old one.
				host.visible = hosts[host.name].visible;
				host.rendered = hosts[host.name].rendered;
			}
			else
			{
				//Init UI state.
				host.visible = false;
				host.rendered = false;
			}
			//Data has been updated since last render.
			host.updated = true;
			
			//Add to the internal representation.
			hosts[host.name] = host;
			
			$('#n_hosts').html(Object.keys(hosts).length);
		}
      	
		//Insert a host entry, sorting them on the go.
		function render(host)
		{
			if (host.updated || (!host.rendered))
			{
				//If host is in the table
				if (host.rendered)
				{
					//Update host.
					var host_body = $('#' + host.id + '_body');
					var host_html = host_row_tmpl.render(host);
					host_body.replaceWith(host_html);				
				}
				else
				{
					//New host, insert.
					if ( sort_value == undefined)
					{
						//No sorting, just append to the end
						var host_html = host_row_tmpl.render(host);
						$('#host_table').append(host_html);
					}
					else
					{
						function sort_host(a, b)
						{
							switch(sort_value)
							{
								case 'name':
									return a[sort_value].localeCompare(b[sort_value]);
									break;
								case 'ip_value':
									if ( a[sort_value] < b[sort_value])
									{
										return -1;
									}
									else if (a[sort_value] == b[sort_value])
									{
										return 0;
									}
									else
									{
										return 1;
									}
									break;
								case 'state':
									return a[sort_value].localeCompare(b[sort_value]);
									break;
								case 'replyHost':
									return a[sort_value].localeCompare(b[sort_value]);
									break;
								case 'time_value':
									if ( a[sort_value] < b[sort_value])
									{
										return -1;
									}
									else if (a[sort_value] == b[sort_value])
									{
										return 0;
									}
									else
									{
										return 1;
									}
									break;
								default: console.log('Unlknown sort entry: ' + sort_value);
							}
						}

						if ( sorted_keys.length < 1 )
						{
							//First entry.
							sorted_keys.push(host.name);
							var host_html = host_row_tmpl.render(host);
							$('#host_table').append(host_html);
							console.log(host.name + ' ' + i);
						}
						else
						{
							
							var sorted = false;
							var i = 0;
							while ( (!sorted) && (i < sorted_keys.length ) )
							{
								var res = sort_host(hosts[sorted_keys[i]], host);
								console.log(hosts[sorted_keys[i]][sort_value] + " == " + host[sort_value] + ": " + res);
								if (res > 0)
								{
									sorted_keys.splice(i, 0, host.name);
									console.log(host.name + ' added at ' + i);
									var host_html = host_row_tmpl.render(host);
									if (i == 0)
									{
										$('tbody[id$="' + hosts[sorted_keys[i]].id + '_body"]').insertBefore(host_html);
									}
									else
									{
										$('tbody[id$="' + hosts[sorted_keys[i - 1]].id + '_body"]').insertAfter(host_html);
									}
									console.log(host.name + ' ' + i);
									sorted = true;	
								}
								else if (i == (sorted_keys.length - 1))
								{
									sorted_keys.splice(i, 0, host.name);
									console.log(host.name + ' added at ' + i);
									var host_html = host_row_tmpl.render(host);
									if (i == 0)
									{
										$('tbody[id$="' + hosts[sorted_keys[i]].id + '_body"]').insertBefore(host_html);
									}
									else
									{
										$('tbody[id$="' + hosts[sorted_keys[i - 1]].id + '_body"]').insertAfter(host_html);
									}
									console.log(host.name + ' ' + i);
									sorted = true;									
								}
								else
								{
									i++;
								}
							}
						}
					}
				}
				//Host is visible.
				host.visible = true;
				//Host is in the table.
				host.rendered = true;
				//Host has new data.
				host.updated = false;
				//Bind the colapse funtion.
				$('#' + host.id + '_expand').click(function()
						{
							$(this).toggleClass('glyphicon-collapse-up glyphicon-collapse-down');
							$('#' + $(this).attr('id').replace('_expand', '_detail')).collapse('toggle');
						});
				//Uncheck the all checkbox
				$('#allhost').prop('checked', false);
			}
		}
		
		//Import hosts from a file
		$('#importOK').click(
				function(e) {
					var file = $('#importFile')[0].files[0];
					console.log("File name: " + file)
				    var reader = new FileReader();
					
			    	reader.onload = function(e)
			    	{
			        	console.log('File loaded');
			        	var hosts = e.target.result.split('\n');
			        	for ( var i = 0; i < hosts.length; i++)
			        	{
			        		//Strip of comments
			        		if (hosts[i][0] == '#')
			        		{
			        			hosts.splice(i, 1);
			        		}
			        	}
			        	ws.send('{ "action" : "add", "hosts" : ' + JSON.stringify(hosts) + ' }');
			    	};
			    	reader.readAsText(file);
				});
	</script>
</body>