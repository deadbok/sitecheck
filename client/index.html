<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<!-- Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
<link rel="stylesheet" type="text/css" href="css/custom.css">
<title>Site check</title>
</head>
<body>
	<div class="page-header sc-header bg-primary">
		<ul class="sc-header-list">
			<li class="text-uppercase sc-title">Site status</li>
			<li class="sc-version">V{{ version }}</li>
			<li class="text-right sc-username">{{ name }}</li>
		</ul>
	</div>
	<div class="container-fluid sc-content">
		<button type="button" class="btn btn-default">Add</button>
		<button type="button" class="btn btn-default">Delete</button>
		<button type="button" class="btn btn-default" id="ping">Ping</button>

		<!-- Trigger the modal with a button -->
		<button type="button" class="btn btn-default" data-toggle="modal"
			data-target="#importModal">Import host...</button>

		<!-- Modal -->
		<div id="importModal" class="modal fade" role="dialog">
			<div class="modal-dialog modal-sm">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Select host list file...</h4>
					</div>
					<form enctype="multipart/form-data" method="post" action="/import">
						<div class="modal-body">
							<input name="file" type="file" class="filestyle" />
						</div>
						<div class="modal-footer">
							<input type="submit" class="btn btn-default" value="OK">
							<button type="button" class="btn btn-default"
								data-dismiss="modal">Cancel</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<form>
			<table id="host_table" style="width: 100%">
				<tr>
					<th><input type="checkbox" id="allhost"></th>
					<th>Host</th>
					<th>IP</th>
					<th>State</th>
					<th>Reply from</th>
					<th>Time</th>
				</tr>
			</table>
		</form>
	</div>
	<div class="loader-container"><div id="loader" class="loader"></div></div>
	<footer class="bg-primary">
		<small><span class="copyright">&copy; Copyright 2016
				Martin Bo Kristensen Gr&oslash;nholdt.</span><a href="LICENSE"
			class="license inverted">Read license.</a></small>
	</footer>
	<script src="js/jquery.js"></script>
	<script src="js/jsrender.js"></script>
	<script src="js/bootstrap.js"></script>
	<script src="js/bootstrap-filestyle.js"></script>
	
	<script id="hostTmpl" type="text/x-jsrender">
	<tr> 
		<td><input type="checkbox" id="host" name="{{:name}}" value=""></td>
		<td><a id="{{:name}}_link" href="http://{{:name}}/" target="_new">{{:name}}</a></td>
		<td id="{{:name}}_ip">{{:ip}}</td>
		<td id="{{:name}}_state">{{:state}}</td>
		<td id="{{:name}}_replyHost">{{:replyHost}}</td>
		<td id="{{:name}}_time">{{:time}}</td>
	</tr>
	</script>
	<script type="text/javascript">
		var host_tmpl = $.templates("#hostTmpl");
		var n_hosts = 0;
		
		/* WebSocket communication with the server. */
		if ("WebSocket" in window) {
			console.log("WebSocket is supported by your Browser!");

			// Let us open a web socket
			var ws = new WebSocket("ws://localhost:5683");
			var rcv_hosts = 0;

			ws.onopen = function() {
				// Web Socket is connected, send data using send()
				ws.send('{ "action" : "get", "hosts" : [ "*" ]}');
				console.log("Message is sent...");
			};

			ws.onmessage = function(evt) {
				console.log("Data received: " + evt.data);
				//Convert to native
				json_data = JSON.parse(evt.data)
				if (typeof(json_data.hosts) != 'undefined')
				{
					console.log(json_data.hosts + "Hosts");
					n_hosts = json_data.hosts;
				}
				else
				{
					console.log("Host: " + json_data.name);
					var host_html = host_tmpl.render(json_data);
					$('#host_table').append(host_html);
					rcv_hosts++;
				}
				if (rcv_hosts == n_host)
				{
					$('#loader').prop('visible', false);
				}
			};

			ws.onclose = function() {
				// websocket is closed.
				console.log("Connection is closed...");
			};
		} else {
			// The browser doesn't support WebSocket
			console.log("WebSocket NOT supported by your Browser!");
		}

		var n = 0;

		/* Select all checkbox functianality */
		$('#allhost').change(function() {
			var checkboxes = $(this).closest('form').find(':checkbox');
			if ($(this).is(':checked')) {
				checkboxes.prop('checked', true);
			} else {
				checkboxes.prop('checked', false);
			}
		});

		$('#ping').click(
				function() {
					console.log('Requesting ping');
					var host_names = $("#host:checked").map(function() {
						return this.value;
					}).get();
					console.log('Hosts: ' + host_names);
					$.post('/action', {
						action : 'ping',
						hosts : JSON.stringify(host_names)
					}).done(function() {
						console.log("Ping request send.")
					}).fail(function() {
						console.log("Ping request failed.")
					});

					n = host_names.length;
					var update_timer = setInterval(function() {
						$.post('/updates', {
							action : 'get'
						}).done(
								function(data) {
									console.log('Update')
									var host = JSON.parse(data)
									if (data != '[]') {
										console.log(host);
										$('input[name = "' + host.name + '"]')
												.prop("checked", false);
										$(
												'#'
														+ host.name.replace(
																'.', '_')
														+ '_time').html(
												host.time);
									}
									n--;
									if (n < 1) {
										clearInterval(update_timer);
									}
								}).fail(function() {
							console.log("Get updates request failed.")
						});
					}, 500);
				});
	</script>
</body>