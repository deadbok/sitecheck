<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<!-- Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
<link rel="stylesheet" type="text/css" href="css/custom.css">
<title>Site check</title>
</head>
<body>
	<div class="container-fluid sc-header bg-primary">
		<div class="row">
			<div class="text-uppercase sc-title col-md-6">Site status</div>
			<div class="text-right col-md-6"><span id="con_state" class="sc-connected sc-offline glyphicon glyphicon-transfer" aria-hidden="true"></span></div>
			<div class="sc-version col-md-6">V{{ version }}</div>
			<div class="text-right sc-username col-md-6">{{ name }}</div>
		</div>
	</div>
	<div class="container-fluid sc-content">
		<button type="button" class="btn btn-default">Add</button>
		<button type="button" class="btn btn-default">Delete</button>
		<button type="button" class="btn btn-default" id="ping">Ping</button>

		<!-- Trigger the modal with a button -->
		<button type="button" class="btn btn-default" data-toggle="modal"
			data-target="#importModal">Import host...</button>

		<!-- Modal -->
		<div id="importModal" class="modal fade" role="dialog">
			<div class="modal-dialog modal-sm">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Select host list file...</h4>
					</div>
					<form enctype="multipart/form-data" method="post" id="server_upload_form">
						<div class="modal-body">
							<input name="file" type="file" class="filestyle" />
						</div>
						<div class="modal-footer">
							<input type="submit" class="btn btn-default" value="OK">
							<button type="button" class="btn btn-default"
								data-dismiss="modal">Cancel</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="filebutton">Send Image<input type="file" id="imageFile" accept="image/*"></div>
		<br />
		<div class="loader-container" id="loader-container">
			<div id="loader" class="loader"></div>
		</div>
		<form>
			<table style="width: 100%">
				<thead>
					<tr>
						<th><input type="checkbox" id="allhost"></th>
						<th>Host</th>
						<th>IP</th>
						<th>State</th>
						<th>Reply from</th>
						<th>Time</th>
					</tr>
				</thead>
				<tbody id="host_table">
				</tbody>
			</table>
		</form>
	</div>
	<footer class="bg-primary">
		<small><span class="copyright">&copy; Copyright 2016
				Martin Bo Kristensen Gr&oslash;nholdt.</span><a href="LICENSE"
			class="license inverted">Read license.</a></small>
	</footer>
	<script src="js/jquery.js"></script>
	<script src="js/jsrender.js"></script>
	<script src="js/bootstrap.js"></script>
	<script src="js/bootstrap-filestyle.js"></script>
	<!-- jsRender template or a host entry. -->
	<script id="hostRowTmpl" type="text/x-jsrender">
		<tr id="{{:id}}_row">
			<td><input type="checkbox" id="host" name="{{:name}}" value="{{:name}}"></td>
			<td><a id="{{:id}}_link" href="http://{{:name}}/" target="_new">{{:name}}</a></td>
			<td id="{{:id}}_ip">{{:ip}}</td>
			<td id="{{:id}}_state">{{:state}}</td
			<td id="{{:id}}_replyHost">{{:replyHost}}</td>
			<td id="{{:id}}_time">{{:time}}</td>
		</tr>
	</script>
	<script id="hostEntryTmpl" type="text/x-jsrender">
		<td><input type="checkbox" id="host" name="{{:name}}" value="{{:name}}"></td>
		<td><a id="{{:id}}_link" href="http://{{:name}}/" target="_new">{{:name}}</a></td>
		<td id="{{:id}}_ip">{{:ip}}</td>
		<td id="{{:id}}_state">{{:state}}</td
		<td id="{{:id}}_replyHost">{{:replyHost}}</td>
		<td id="{{:id}}_time">{{:time}}</td>
	</script>
	
	<script type="text/javascript">
		var host_row_tmpl = $.templates("#hostRowTmpl");
		var host_entry_tmpl = $.templates("#hostEntryTmpl");
		
		/* WebSocket communication with the server. */
		if ("WebSocket" in window)
		{
			console.log("WebSocket is supported by your Browser!");

			// Open a socket.
			var ws = new WebSocket("ws://localhost:5683");

			ws.onopen = function()
			{
				// Web Socket is connected, get all hosts.
				$('#con_state').css('color', 'green');
				ws.send('{ "action" : "get", "hosts" : [ "*" ]}');
				console.log("Message is sent...");
			};

			ws.onmessage = function(evt)
			{
				var json_data = JSON.parse(evt.data)
				var n_hosts = json_data.length;
				//Run through the host names.
				for (var i = 0; i < n_hosts; i++)
				{
					var host = json_data.hosts[i];
					host.id = host.name.replace('.', '_');
					console.log("Host: " + host.name);
					//Check if the host is in the list.
					host_row = $('#' + host.id + '_row')
					if (host_row.length == 0)
					{
						var host_html = host_row_tmpl.render(host);
						$('#host_table').append(host_html);
						if ((i + 1) == n_hosts)
						{
							$('#loader').hide();
							$('#loader-container').hide();
						}
					}
					else
					{
						host_row.html('');
						var host_html = host_entry_tmpl.render(host);
						host_row.append(host_html);
					}
				}
			};

			ws.onclose = function()
			{
				// websocket is closed.
				$('#con_state').css('color', 'red');
				console.log("Connection is closed...");
			};
			
			$('#imageFile').on('change', function(e)
			{
				var file = e.originalEvent.target.files[0];
				console.log("File name: " + file)
			    var reader = new FileReader();
		    	//When the file has been read...
		    	reader.onload = function(evt)
		    	{
		        	//Because of how the file was read,
		        	//evt.target.result contains the image in base64 format
		        	//Nothing special, just creates an img element
		        	//and appends it to the DOM so my UI shows
		        	//that I posted an image.
		        	//send the image via Socket.io
		        	console.log('File loaded');
		    	};
		    	//And now, read the image and base64.
		    	reader.readAsDataURL(file);
			});
		}
		else
		{
			//The browser doesn't support WebSocket.
			console.log("WebSocket NOT supported by your Browser!");
		}

		//Select all checkboxes functionality.
		$('#allhost').change(function() {
			var checkboxes = $(this).closest('form').find(':checkbox');
			if ($(this).is(':checked'))
			{
				checkboxes.prop('checked', true);
			}
			else
			{
				checkboxes.prop('checked', false);
			}
		});

		//Request a ping of some servers.
		$('#ping').click(
				function() {
					console.log('Requesting ping');
					var host_names = $("#host:checked").map(function() {
						return this.value;
					}).get();
					console.log('Hosts: ' + host_names);
					ws.send('{ "action" : "ping", "hosts" : ' + JSON.stringify(host_names) + ' }');
				});
	</script>
</body>