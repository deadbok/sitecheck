<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<!-- Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet">

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
		  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
		  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
		<![endif]-->
<link rel="stylesheet" type="text/css" href="css/custom.css">
<title>Site check</title>
</head>
<body>
	<div class="container-fluid sc-header blueback">
		<div class="row">
			<div class="text-uppercase sc-title col-md-6">Site status</div>
			<div class="text-right col-md-6"><span id="con_state" class="sc-connected sc-offline glyphicon glyphicon-link" aria-hidden="true"></span></div>
			<div class="sc-version col-md-6">V0.3.0</div>
			<div class="text-right sc-username col-md-6">{{ name }}</div>
		</div>
	</div>
	<div class="container-fluid sc-content">
		<button type="button" class="btn btn-default">Add</button>
		<button type="button" class="btn btn-default">Delete</button>
		<button type="button" class="btn btn-default" id="ping">Ping</button>

		<!-- Trigger the modal with a button -->
		<button type="button" class="btn btn-default" data-toggle="modal"
			data-target="#importModal">Import host...</button>

		<!-- Modal -->
		<div id="importModal" class="modal fade" role="dialog">
			<div class="modal-dialog modal-sm">
				<!-- Modal content-->
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<h4 class="modal-title">Select host list file...</h4>
					</div>
					<form enctype="multipart/form-data" method="post" id="server_upload_form">
						<div class="modal-body">
							<input name="file" type="file" id="importFile" class="filestyle" />
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-default" id="importOK" data-dismiss="modal">OK</button>
							<button type="button" class="btn btn-default"
								data-dismiss="modal">Cancel</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<form>
			<div class="table-responsive">
				<table style="width: 100%" class="table table-hover">
					<thead>
						<tr>
							<th><input type="checkbox" id="allhost"></th>
							<th id="host_header" data-sort="string" class="sort_pointer">Host </th>
							<th id="ip_header" data-sort="int" class="sort_pointer">IP </th>
							<th id="state_header" data-sort="string" class="sort_pointer">State </th>
							<th id="replyHost_header" data-sort="string" class="sort_pointer">Reply from </th>
							<th id="time_header" data-sort="int" class="sort_pointer">Time </th>
						</tr>
					</thead>
					<tbody id="host_table">
					</tbody>
				</table>
			</div>
		</form>
	</div>
	<footer class="blueback">
		<small><span class="copyright">&copy; Copyright 2016
				Martin Bo Kristensen Gr&oslash;nholdt.</span>
				<a class="license" href="LICENSE">Read license.</a></small>
	</footer>
	<script src="js/jquery.js"></script>
	<script src="js/jsrender.js"></script>
	<script src="js/bootstrap.js"></script>
	<script src="js/bootstrap-filestyle.js"></script>
	<script src="js/selectall.js"></script>
	<script src="js/stupidtable.js"></script>
	<script src="js/date.format.js"></script>
	
	<!-- jsRender template or a host entry. -->
	<script id="hostRowTmpl" type="text/x-jsrender">
		<tr id="{{:id}}_row">
			<td><input type="checkbox" id="host" name="{{:name}}" value="{{:name}}"></td>
			<td><a id="{{:id}}_link" href="http://{{:name}}/" target="_new">{{:name}}</a></td>
			<td id="{{:id}}_ip" data-sort-value="{{:ip_value}}">{{:ip}}</td>
			<td id="{{:id}}_state">{{:state}}</td>
			<td id="{{:id}}_replyHost">{{:replyHost}}</td>
			<td id="{{:id}}_time" data-sort-value="{{:time_value}}">{{:time}}</td>
		</tr>
	</script>
	<script id="hostEntryTmpl" type="text/x-jsrender">
		<td><input type="checkbox" id="host" name="{{:name}}" value="{{:name}}"></td>
		<td><a id="{{:id}}_link" href="http://{{:name}}/" target="_new">{{:name}}</a></td>
		<td id="{{:id}}_ip" data-sort-value="{{:ip_value}}">{{:ip}}</td>
		<td id="{{:id}}_state">{{:state}}</td>
		<td id="{{:id}}_replyHost">{{:replyHost}}</td>
		<td id="{{:id}}_time" data-sort-value="{{:time_value}}">{{:time}}</td>
	</script>
	
	<script type="text/javascript">
		var host_row_tmpl = $.templates("#hostRowTmpl");
		var host_entry_tmpl = $.templates("#hostEntryTmpl");
		var sort_header = $('#host_header');
		
		//Hide the tample until some data is in it.
		$('#host_table').hide();
		//Sort the table.
		var table = $('table').stupidtable();
		
		//Set the sort indicator.
      	table.on("aftertablesort", function (event, data)
      	{
      		var th = $(this).find("th");
      		th.find("#arrow").remove();
      		
      		var dir = $.fn.stupidtable.dir;
      		if (data.direction === dir.ASC)
      		{
      			var arrow = "glyphicon glyphicon-chevron-up";
      		}
      		else
      		{
      			var arrow = "glyphicon glyphicon-chevron-down";
      		}
      		sort_header = th.eq(data.column);
      		sort_header.append('<span id="arrow" class="' + arrow + '"></span>');
		});
      	
		//Insert a host entry, sorting them on the go.
		function render(host)
		{
			//Generate CSS safe id.
			host.id = host.name.replace('.', '_');
			//Generate IP sort key.
			if ((host.ip == 'Unknown') || (host.ip == undefined))
			{
				host.ip = 'Unknown'
				host.ip_value = 0;
			}
			else
			{
				var ip_split = host.ip.split('.');
				host.ip_value = ip_split[0]*0x1000000 + ip_split[1]*0x10000 + ip_split[2]*0x100 + ip_split[3]*1;
			}
			//Generate time sort key.
			if ((host.time == undefined) || (host.time == 'Never'))
			{
				host.time = 0;	
			}
			host.time_value = host.time
			dt = new Date(host.time * 1000) 
			host.time = new Date(host.time * 1000).format('H:i:s j/n-Y');
			
			console.log("Host: " + host.name);
			//Check if the host is in the list.
			host_row = $('#' + host.id + '_row')
			if (host_row.length == 0)
			{
				//New host, append.
				var host_html = host_row_tmpl.render(host);
				$('#host_table').append(host_html);
			}
			else
			{
				//Update host.
				host_row.html('');
				var host_html = host_entry_tmpl.render(host);
				host_row.append(host_html);
			}
			//Update table sort data
			$('#' + host.id + '_link').updateSortVal(host.name);
			$('#' + host.id + '_ip').updateSortVal(host.ip_value);
			$('#' + host.id + '_replyHost').updateSortVal(host.replyHost);
			$('#' + host.id + '_state').updateSortVal(host.state);
			$('#' + host.id + '_time').updateSortVal(host.time_value);
			//Uncheck the all checkbox
			$('#allhost').prop('checked', false);
			console.log('Updated ' + JSON.stringify(host));
		}
		
		/* WebSocket communication with the server. */
		if ("WebSocket" in window)
		{
			console.log("WebSocket is supported by your Browser!");

			// Open a socket.
			var ws = new WebSocket("ws://localhost:5683");

			ws.onopen = function()
			{
				// Web Socket is connected, get all hosts.
				$('#con_state').css('color', '#00ff00');
				ws.send('{ "action" : "get", "hosts" : [ "*" ]}');
				console.log("Message is sent...");
			};

			ws.onmessage = function(e)
			{
				var json_data = JSON.parse(e.data)
				//Run through the host names.
				for (var i = 0; i < json_data.length; i++)
				{
					render(json_data.hosts[i]);
				}
				//Re-sort
				sort_header.stupidsort();

				//Make sure the spinner is hidden and the host table is visible.
				$('#loader').hide();
				$('#loader-container').hide();
				$('#host_table').show();
			};

			ws.onclose = function()
			{
				// websocket is closed.
				$('#con_state').css('color', 'red');
				console.log("Connection is closed...");
			};
			
			$('#importOK').on('click', function(e)
			{
				var file = $('#importFile')[0].files[0];
				console.log("File name: " + file)
			    var reader = new FileReader();
				
		    	reader.onload = function(e)
		    	{
		        	//Because of how the file was read,
		        	//evt.target.result contains the image in base64 format
		        	//Nothing special, just creates an img element
		        	//and appends it to the DOM so my UI shows
		        	//that I posted an image.
		        	//send the image via Socket.io
		        	console.log('File loaded');
		        	var hosts = e.target.result.split('\n');
		        	for ( var i = 0; i < hosts.length; i++)
		        	{
		        		//Strip of comments
		        		if (hosts[i][0] == '#')
		        		{
		        			hosts.splice(i, 1);
		        		}
		        	}
		        	ws.send('{ "action" : "add", "hosts" : ' + JSON.stringify(hosts) + ' }');
		    	};
		    	//And now, read the image and base64.
		    	reader.readAsText(file);
			});
		}
		else
		{
			//The browser doesn't support WebSocket.
			console.log("WebSocket NOT supported by your Browser!");
		}

		//Request a ping of some servers.
		$('#ping').click(
				function() {
					console.log('Requesting ping');
					var host_names = $("#host:checked").map(function() {
						return this.value;
					}).get();
					console.log('Hosts: ' + host_names);
					ws.send('{ "action" : "ping", "hosts" : ' + JSON.stringify(host_names) + ' }');
				});
	</script>
</body>