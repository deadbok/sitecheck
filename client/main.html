{% extends "bootstrap/base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='custom.css') }}">
<meta charset="UTF-8"> 
{% endblock %}

{% block title %}Site status{% endblock %}

{% block navbar %}
<div class="page-header sc-header bg-primary">
	<ul class="sc-header-list">
		<li class="text-uppercase sc-title">Site status</li>
		<li class="sc-version">V{{ version }}</li>
		<li class="text-right sc-username">{{ name }}</li>
	</ul>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid sc-content">
	<button type="button" class="btn btn-default">Add</button>
	<button type="button" class="btn btn-default">Delete</button>
	<button type="button" class="btn btn-default" id="ping"">Ping</button>

	<!-- Trigger the modal with a button -->
	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#importModal">Import host...</button>
	
	<!-- Modal -->
	<div id="importModal" class="modal fade" role="dialog">
		<div class="modal-dialog modal-sm">
	    	<!-- Modal content-->
	    	<div class="modal-content">
	      		<div class="modal-header">
	        		<button type="button" class="close" data-dismiss="modal">&times;</button>
	        		<h4 class="modal-title">Select host list file...</h4>
	      		</div>
	      		<form enctype="multipart/form-data" method="post" action="/import">
	      			<div class="modal-body">
	       		    	<input name="file" type="file" class="filestyle"/>
	      			</div>
	   		      	<div class="modal-footer">
	    				<input type="submit" class="btn btn-default" value="OK">
	        			<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
	      			</div>
	     		</form>
			</div>
		</div>
	</div>
	<form>
		<table style="width:100%">
			<tr>
				<th><input type="checkbox" id="allhost"></th>
				<th>Host</th>
				<th>IP</th>
				<th>State</th>
				<th>Reply from</th>
				<th>Time</th>
			</tr>
			{% for host in hosts.values() %}
			<tr>
				<td><input type="checkbox" id="host" name="{{ host.name.strip() }}" value="{{ host['name'].strip() }}"></td>
				<td><a id="{{ host.name.strip() }}_link" href="http://{{ host.name.strip() }}/" target="_new">{{ host.name.strip() }}</a></td>
			
			  	{% if host.ip is equalto None %}
					<td id="{{ host.name.strip() }}_ip">Unknown</td>
			  	{% else %}
					<td id="{{ host.name.strip() }}_ip">{{ host.ip }}</td>
			  	{% endif %}
			
			  	{% if host.alive is equalto None %}
					<td id="{{ host.name.strip() }}_alive" class="sc-unknown">Unknown</td>
			  	{% else %}
			  		{% if host.alive is equalto True %}
						<td id="{{ host.name.strip() }}_alive" class="sc-online">Online</td>
					{% else %}
						<td id="{{ host.name.strip() }}_alive" class="sc-offline">Offline</td>
					{% endif %}		
			  	{% endif %}
			  	
			  	{% if host.replyHost is equalto None %}
					<td id="{{ host.name.strip() }}_replyHost">Unknown</td>
			  	{% else %}
					<td id="{{ host.name.strip() }}_replyHost">{{ host.replyHost.decode('utf-8') }}</td>
			  	{% endif %}
				<td id="{{ host.name.strip().replace('.', '_') }}_time">{{ host.time }}</td>
			</tr>
			{% endfor %}
		</table>
	</form>
</div>
<footer class="bg-primary">
	<small><span class="copyright">&copy; Copyright 2016 Martin Bo Kristensen Gr&oslash;nholdt.</span><a href="LICENSE" class="license inverted">Read license.</a></small>
</footer> 
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='bootstrap-filestyle.min.js') }}"> </script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript">
var n = 0;

/* Select all checkbox functianality */
$('#allhost').change(function()
		{
    		var checkboxes = $(this).closest('form').find(':checkbox');
    		if($(this).is(':checked'))
    		{
        		checkboxes.prop('checked', true);
    		}
    		else
    		{
        		checkboxes.prop('checked', false);
    		}
		}
);

$('#ping').click(function()
{	
	console.log('Requesting ping');
	var host_names = $("#host:checked").map(function () {return this.value;}).get();
	console.log('Hosts: ' + host_names);
	$.post('/action', {
		action: 'ping',
		hosts: JSON.stringify(host_names)
    }).done(function() {
		console.log("Ping request send.")
    }).fail(function() {
    	console.log("Ping request failed.")    
    });
	
	n = host_names.length;
	var update_timer = setInterval(function()
			{
				$.post('/updates', {
					action: 'get'
	    		}).done(function(data) {
					console.log('Update')
					var host = JSON.parse(data) 
					if (data != '[]')
					{
						console.log(host);
						$('input[name = "' + host.name +'"]').prop( "checked", false );
						$('#' + host.name.replace('.', '_') + '_time').html(host.time);
					}
					n--;
					if (n < 1)
					{
						clearInterval(update_timer);
					}
	    		}).fail(function() {
	    			console.log("Get updates request failed.")    
	    		});
			}, 500);
});
</script>
{% endblock %}