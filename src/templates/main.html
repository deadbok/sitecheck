{% extends "bootstrap/base.html" %}

{% block head %}
{{ super() }}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='custom.css') }}">
{% endblock %}

{% block title %}Site status{% endblock %}

{% block navbar %}
<div class="page-header sc-header bg-primary">
	<ul class="sc-header-list">
		<li class="text-uppercase sc-title">Site status</li>
		<li class="sc-version">V{{ version }}</li>
		<li class="text-right sc-username">{{ name }}</li>
	</ul>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid sc-content">
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Log</h3>
		</div>
		<div class="panel-body sc-log" id="log">
		</div>
	</div>
	<button type="button" class="btn btn-default" onclick="add()">Add</button>
	<button type="button" class="btn btn-default" onclick="delete()">Delete</button>
	<button type="button" class="btn btn-default" onclick="ping()">Ping</button>
	<!-- Trigger the modal with a button -->
	<button type="button" class="btn btn-default" data-toggle="modal" data-target="#importModal">Import host...</button>
	
	<!-- Modal -->
	<div id="importModal" class="modal fade" role="dialog">
		<div class="modal-dialog modal-sm">
	    	<!-- Modal content-->
	    	<div class="modal-content">
	      		<div class="modal-header">
	        		<button type="button" class="close" data-dismiss="modal">&times;</button>
	        		<h4 class="modal-title">Select host list file...</h4>
	      		</div>
	      		<form enctype="multipart/form-data" method="post" action="/import">
	      			<div class="modal-body">
	       		    	<input name="file" type="file" class="filestyle"/>
	      			</div>
	   		      	<div class="modal-footer">
	    				<input type="submit" class="btn btn-default" value="OK">
	        			<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
	      			</div>
	     		</form>
			</div>
		</div>
	</div>
	<form>
		<table style="width:100%">
			<tr>
				<th><input type="checkbox" id="allhost"></th>
				<th>Host</th>
				<th>IP</th>
				<th>State</th>
				<th>Reply from</th>
			</tr>
			{% for host in hosts %}
			<tr>
				<td><input type="checkbox" id="host" name="{{ host.name.decode('utf-8') }}" value="{{ host.name.decode('utf-8') }}"></td>
				<td><a href="http://{{ host.name.decode('utf-8') }}/" target="_new">{{ host.name.decode('utf-8') }}</a></td>
			
			  	{% if host.ip is equalto None %}
					<td>Unknown</td>
			  	{% else %}
					<td>{{ host.ip }}</td>
			  	{% endif %}
			
			  	{% if host.alive is equalto None %}
					<td class="sc-unknown">Unknown</td>
			  	{% else %}
			  		{% if host.alive is equalto True %}
						<td class="sc-online">Online</td>
					{% else %}
						<td class="sc-offline">Offline</td>
					{% endif %}		
			  	{% endif %}
			  	
			  	{% if host.replyHost is equalto None %}
					<td>Unknown</td>
			  	{% else %}
					<td>{{ host.replyHost.decode('utf-8') }}</td>
			  	{% endif %}
			</tr>
			{% endfor %}
		</table>
	</form>
</div>
<footer class="bg-primary">
	<small><span class="copyright">&copy; Copyright 2016 Martin Bo Kristensen Gr&oslash;nholdt.</span><a href="LICENSE" class="license inverted">Read license.</a></small>
</footer> 
{% endblock %}

{% block scripts %}
{{ super() }}
<script type="text/javascript" src="{{ url_for('static', filename='bootstrap-filestyle.min.js') }}"> </script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
<script type="text/javascript">
/* Select all checkbox functianality */
$('#allhost').change(function()
		{
    		var checkboxes = $(this).closest('form').find(':checkbox');
    		if($(this).is(':checked'))
    		{
        		checkboxes.prop('checked', true);
    		}
    		else
    		{
        		checkboxes.prop('checked', false);
    		}
		}
);

var hosts = new Array();

var socket = io.connect('http://' + document.domain + ':' + location.port);
socket.on('connect', function()
		{
			console.log("WebSocket connected");
			socket.emit('hello');
		});
		
socket.on('hello', function()
		{
			console.log("Hello from backend");		
			addLogLine('Hello from backend');
		});

socket.on('log_line', function(msg)
		{
			console.log("WebSocket message: " + msg);
			addLogLine(msg);
		});
		
		
function getHosts()
{
	$('#host :checked').each(function() {
		console.log("Host: " + $(this).val())
		hosts.push($(this).val());
	});
}

function addLogLine(text)
{
	var div = document.getElementById('log');
	var lines = $("#log").height() / parseFloat($("#log").css("line-height"));
	
	if (lines > 5)
	{
		div.innerHTML = text + '<br />';
	}
	else
	{
		div.innerHTML = div.innetHTML + text + '<br />';
	}
}

function ping()
{
	console.log('Requesting ping');
	var hosts = $("#host:checked").map(function () {return this.value;}).get().join("");
	socket.emit('ping', hosts);
}

function add()
{
	console.log('Requesting ping');
	socket.emit('ping');
}

function del()
{
	console.log('Requesting ping');
	socket.emit('ping');
}
</script>
{% endblock %}